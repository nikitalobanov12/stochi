# ðŸ— Technical Design Document (TDD)

## 1. System Architecture (The "Hybrid" Stack)

We use a **Next.js** frontend for the PWA experience and a **Go** backend for high-performance graph logic, connected via a shared Monorepo.

- **Repository:** Monorepo (`apps/web` + `apps/engine`).
- **Frontend:** Next.js 15 (App Router) + TypeScript.
  - **UI Lib:** shadcn/ui + Tailwind CSS.
  - **Mobile:** `next-pwa` for Installability.
- **Backend:** Go 1.23.
  - **Role:** The "Calculation Engine." Handles graph traversal, ratio logic, and OCR processing.
- **Database:** PostgreSQL (Neon Serverless).
  - **Auth Store:** BetterAuth Tables (`user`, `session`, `account`).
  - **Data Store:** Supplements, Stacks, Interactions.

## 2. Data Strategy: "Drizzle is Master, Go is Reader"

To maintain type safety across two languages without duplication:

1.  **Schema Definition (TypeScript):**
    - Defined in `apps/web/db/schema.ts` using **Drizzle ORM**.
    - Drizzle manages migrations and applies them to Neon.
2.  **Go Integration (SQL Compiler):**
    - **Tool:** `sqlc`.
    - **Workflow:** `sqlc` reads the SQL migrations generated by Drizzle and auto-generates type-safe Go structs (`models.go`) and query methods (`db.go`).
    - _Benefit:_ No manual struct mapping. Go types are always in sync with the DB.

## 3. Database Schema (Core Entities)

### `supplements`

- `id` (UUID)
- `name` (String) - e.g., "Thorne Citramate"
- `form` (String) - e.g., "Magnesium Citrate"
- `elemental_weight` (Float) - The actual amount of Mg in the salt.

### `interactions` (The Graph Edges)

- `source_id` (FK -> supplements)
- `target_id` (FK -> supplements)
- `type` (Enum: "inhibition", "synergy", "competition")
- `mechanism` (String) - e.g., "DMT1 Transporter"
- `severity` (Enum: "low", "medium", "critical")

## 4. Authentication Flow (BetterAuth)

1.  **Client:** User logs in via Passkey on Next.js.
2.  **Storage:** BetterAuth writes session token to Postgres `session` table.
3.  **API Call:** Next.js calls Go API (`POST /engine/analyze`) with the Session Cookie.
4.  **Verification:** Go Middleware queries the Postgres `session` table directly to validate the token.
    - _Advantage:_ No shared secrets or JWT decoding logic required in Go.

## 5. Deployment Infrastructure

- **Database:** Neon (Serverless Postgres).
- **Frontend (Web):** Vercel (Auto-deploy from `main`).
- **Backend (Engine):** Docker Container on Railway or Fly.io (Go binary).
  - _Why separate hosting?_ Vercel Serverless Functions have timeouts. The Go engine needs to run complex graph traversals that might exceed 10s limits if the graph grows large.

## 6. Development Workflow (Makefile)

```makefile
schema:
    # 1. Generate SQL from TS Schema
    cd apps/web && npx drizzle-kit generate
    # 2. Generate Go Code from SQL
    cd apps/engine && sqlc generate
```
